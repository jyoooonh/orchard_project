{% extends 'base.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            {% include 'manager/manager_main_menu.html' %}
            <div class="col-md-10">
                <div class="row">
                    {% for report in weekly_reports %}
                        <div class="container-fluid border mb-3" id="report_div_{{ forloop.counter }}" style="width:1160px; height:720px">
                            <div class="row mt-2">
                                <div class="col-md-2 mb-2">
                                    <div style="height:550px">
                                        <div class="card">
                                            <div class="card-header bg-success-subtle"
                                                 style="display: flex; align-items: center;">
                                                <h4 class="card-title" style="margin: 0;">
                                                    <strong>{{ report.student_name }}</strong></h4>
                                            </div>
                                            <div class="card-header">
                                                <h5 class="card-text">{{ report.week_name }}</h5>
                                                <p class="card-text">{{ report.start_date }}
                                                    ~ {{ report.end_date }}</p>
                                            </div>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item bg-danger text-white"
                                                    style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>수면</strong>
                                                        </div>
                                                        <div class="col-md-6">{{ report.study_counts.sleep }}회</div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item bg-info-subtle"
                                                    style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>집중도</strong>
                                                        </div>
                                                        <div class="col-md-6"
                                                             style="text-align: center">{{ report.focus_score.focus_score }}</div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item bg-secondary"
                                                    style="white-space: nowrap;"></li>
                                                <li class="list-group-item" style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>질의응답</strong>
                                                        </div>
                                                        <div class="col-md-6"
                                                             style="text-align: center">{{ report.study_counts.question }}회
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item" style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>상담</strong>
                                                        </div>
                                                        <div class="col-md-6"
                                                             style="text-align: center">{{ report.study_counts.consulting }}회
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item" style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>멘토링</strong>
                                                        </div>
                                                        <div class="col-md-6"
                                                             style="text-align: center">{{ report.study_counts.mentoring }}회
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item" style="white-space: nowrap;">
                                                    <div class="row">
                                                        <div class="col-md-6" style="text-align: center">
                                                            <strong>계획정리</strong>
                                                        </div>
                                                        <div class="col-md-6"
                                                             style="text-align: center">{{ report.study_counts.plan }}회
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item bg-secondary"
                                                    style="white-space: nowrap;"></li>
                                                <li class="list-group-item"
                                                    style="white-space: nowrap; font-size: 15px">
                                                    <div class="row">
                                                        <div class="col-md-5" style="text-align: left">
                                                            <strong>총 인강</strong>
                                                        </div>
                                                        <div class="col-md-7" style="text-align: left">
                                                            {{ report.study_data.total_lecture_study_hour }}h
                                                            {{ report.study_data.total_lecture_study_min }}m
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item"
                                                    style="white-space: nowrap; font-size: 15px">
                                                    <div class="row">
                                                        <div class="col-md-5" style="text-align: left">
                                                            <strong>총 자습</strong>
                                                        </div>
                                                        <div class="col-md-7" style="text-align: left">
                                                            {{ report.study_data.total_self_study_hour }}h
                                                            {{ report.study_data.total_self_study_min }}m
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item"
                                                    style="white-space: nowrap; font-size: 15px">
                                                    <div class="row">
                                                        <div class="col-md-5" style="text-align: left">
                                                            <strong>총 학습</strong>
                                                        </div>
                                                        <div class="col-md-7" style="text-align: left">
                                                            {{ report.study_data.total_study_hour }}h
                                                            {{ report.study_data.total_study_min }}m
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div>
                                        <img style="max-height: 120px" src="{% static '3.jpg' %}"
                                             alt="logo"/>
                                        <img src="{% static 'save_btn.png' %}"
                                         class="save-btn"
                                         data-target="report_div_{{ forloop.counter }}"
                                         data-student-name="{{ report.student_name }}"
                                         data-week-name="{{ report.week_name }}"
                                         alt="이미지 저장" style="cursor:pointer; height:30px; width:30px; opacity:0.05"/>
                                    </div>
                                </div>
                                <div class="col-md-10">
                                    <div class="card border border-success" style="height:390px">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <figure class="highcharts-figure">
                                                    <div id="container_semicircle_student_{{ forloop.counter }}"></div>
                                                </figure>
                                            </div>
                                            <div class="col-md-6">
                                                <figure class="highcharts-figure">
                                                    <div id="container_semicircle_patrol_{{ forloop.counter }}"></div>
                                                </figure>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <figure class="highcharts-figure">
                                                <div id="container_stack_bar_student_{{ forloop.counter }}"></div>
                                            </figure>
                                            </div>
                                            <div class="col-md-6">
                                                <figure class="highcharts-figure">
                                                <div id="container_stack_bar_patrol_{{ forloop.counter }}"></div>
                                            </figure>
                                            </div>
                                        </div>
                                        <div class="card border border-success" style="height:300px">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <figure class="highcharts-figure">
                                                        <div id="container_column_{{ forloop.counter }}"></div>
                                                    </figure>
                                                </div>
                                                <div class="col-md-6">
                                                    <figure class="highcharts-figure">
                                                        <div id="container_column_total{{ forloop.counter }}"></div>
                                                    </figure>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <script>
    {#    일일 순찰 semicircle 차트 #}
        {% for report in weekly_reports %}
            Highcharts.chart('container_semicircle_patrol_{{ forloop.counter }}', {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: 0,
                    plotShadow: false,
                    height: (7 / 16 * 100) + '%'
                },
                title: {
                    text: '집중 관찰 결과',
                    align: 'center',
                    verticalAlign: 'middle',
                    y: -60
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}:{point.percentage:.1f}%',
                            formatter: function () {
                                return this.point.name + ':' + Math.round(this.percentage / {{ report.study_counts.total_study_count}} * 100) + '%';
                            },
                            distance: -40,
                            color: 'black',
                        },
                        startAngle: -90,
                        endAngle: 90,
                        center: ['50%', '128%'],
                        size: '230%',
                        colors: ['#FFE699', '#8BE88B', '#FFA931', '#63C9E8', '#A795D7']
                    },
                },
                series: [{
                    type: 'pie',
                    name: '',
                    innerSize: '40%',
                    data: [
                        {
                            name: '국어',
                            y: {{ report.study_counts.korean_total }}
                        },
                        {
                            name: '수학',
                            y: {{ report.study_counts.math_total }}
                        },
                        {
                            name: '영어',
                            y: {{ report.study_counts.english_total }}
                        },
                        {
                            name: '탐구',
                            y: {{ report.study_counts.research_total }}
                        }
                    ]
                }]
            });
        {% endfor %}
    </script>
    <script>
        {% for report in weekly_reports %}
            {#Highcharts.Templating.helpers.abs = (value) => Math.abs(value);#}
            Highcharts.chart('container_stack_bar_patrol_{{ forloop.counter }}', {
                chart: {
                    type: 'bar',
                    height: (6 / 16 * 100) + '%'
                },
                title: {
                    text: null,
                },
                xAxis: {
                    categories: ['국어', '수학', '영어', '탐구'],
                    LineWidth: 0
                },
                yAxis: {
                    title: {
                        text: ''
                    },
                    labels: {
                        format: "{abs value}",
                    },
                },
                legend: {
                    reversed: false
                },
                plotOptions: {
                    bar: {
                        colorByPoint: false,
                        groupPadding: 0.05, // 그룹 간격 설정
                        pointWidth: 12,
                        colors: ['#FFE699', '#8BE88B', '#FFA931', '#63C9E8', '#A795D7']
                    },
                    series: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: true,
                            formatter: function () {
                                return Math.abs(this.y);
                            }
                        },
                        borderRadius: "50%",
                    }
                },
                series: [{
                    name: '인강',
                    data: [(-{{ report.study_counts.k_il }} * 30), (-{{ report.study_counts.m_il }} * 30), (-{{ report.study_counts.e_il }} * 30), (-{{ report.study_counts.r_il }} * 30)],
                    color: '#00FF00'
                }, {
                    name: '자습',
                    data: [({{ report.study_counts.k_ss }} * 30), ({{ report.study_counts.m_ss }} * 30),
            ({{ report.study_counts.e_ss }} * 30), ({{ report.study_counts.r_ss }} * 30)],
            color: '#00BFFF'
            }]
            });
        {% endfor %}
    </script>
    <script>
    {#    플래너 semicircle 차트 #}
        {% for report in weekly_reports %}
            Highcharts.chart('container_semicircle_student_{{ forloop.counter }}', {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: 0,
                    plotShadow: false,
                    height: (7 / 16 * 100) + '%'
                },
                title: {
                    text: '학생 플래너',
                    align: 'center',
                    verticalAlign: 'middle',
                    y: -60
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                        pie: {
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}:{point.percentage:.1f}%',
                                formatter: function () {
                                    return this.point.name + ':' + Math.round(this.percentage / {{ report.study_data.total_study }} * 100) + '%';
                                },
                                distance: -18,
                                color: 'black',
                            },
                            startAngle: -90,
                            endAngle: 90,
                            center: ['50%', '128%'],
                            size: '230%',
                            colors: ['#FFE699', '#8BE88B', '#FFA931', '#63C9E8', '#A795D7']
                        },
                    },
                series: [{
                    type: 'pie',
                    name: '',
                    innerSize: '40%',
                    data: [
                        {
                            name: '국어',
                            y: {{ report.study_data.korean_study }}
                        },
                        {
                            name: '수학',
                            y: {{ report.study_data.math_study }}
                        },
                        {
                            name: '영어',
                            y: {{ report.study_data.english_study }}
                        },
                        {
                            name: '탐구1',
                            y: {{ report.study_data.research1_study }}
                        },
                        {
                            name: '탐구2',
                            y: {{ report.study_data.research2_study }}
                        },
                    ]
                }]
            });
        {% endfor %}
    </script>
    <script>
        {% for report in weekly_reports %}
            Highcharts.Templating.helpers.abs = (value) => Math.abs(value);
            Highcharts.chart('container_stack_bar_student_{{ forloop.counter }}', {
                chart: {
                    type: 'bar',
                    height: (6 / 16 * 100) + '%'
                },
                title: {
                    text: ''
                },
                xAxis: {
                    categories: ['국어', '수학', '영어', '탐구1', '탐구2'],
                    LineWidth: 0
                },
                yAxis: {
                    title: {
                        text: ''
                    },
                    labels: {
                        format: "{abs value}",
                    },
                },
                legend: {
                    reversed: false
                },
                plotOptions: {
                    bar: {
                        colorByPoint: false,
                        groupPadding: 0.05, // 그룹 간격 설정
                        pointWidth: 10,
                    },
                    series: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: true,
                            formatter: function () {
                                return Math.abs(this.y);
                            }
                        },
                        borderRadius: "50%",
                    }
                },
                series: [{
                    name: '인강',
                    data: [(-{{ report.study_data.korean_lecture_study }}), (-{{ report.study_data.math_lecture_study }}), (-{{ report.study_data.english_lecture_study }}), (-{{ report.study_data.research1_lecture_study }}), (-{{ report.study_data.research2_lecture_study }})],
                    color: '#00FF00'
                }, {
                    name: '자습',
                    data: [{{ report.study_data.korean_self_study }}, {{ report.study_data.math_self_study }}, {{ report.study_data.english_self_study }}, {{ report.study_data.research1_self_study }}, {{ report.study_data.research2_self_study }}],
                    color: '#00BFFF'
                },
                ]
            });
        {% endfor %}
    </script>
    {#    학생 비교 차트 #}
    <script>
        {% for report in weekly_reports %}
            Highcharts.chart('container_column_{{ forloop.counter }}', {
                chart: {
                    type: 'column',
                    height: (10 / 16 * 100) + '%'
                },
                title: {
                    text: '전체 학생 대비 과목별 내 공부량'
                },
                xAxis: {
                    categories: [
                        '국어',
                        '수학',
                        '영어',
                        '탐구'
                    ]
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: ''
                    }
                },
                legend: {
                    itemWidth: 170,
                },
                tooltip: {
                    shared: true
                },
                plotOptions: {
                    column: {
                        grouping: false,
                        shadow: false,
                        borderWidth: 0
                    }
                },
                series: [{
                    name: '총 학생 인강 시간 평균',
                    {# 연두색 #}
                    color: 'rgba(144,238,144,1)',
                    data: [{{ report.average_data.average_korean_lecture_study }}, {{ report.average_data.average_math_lecture_study }}, {{ report.average_data.average_english_lecture_study }}, {{ report.average_data.average_research_lecture_study }}],
                    pointPadding: 0.3,
                    pointPlacement: -0.2
                }, {
                    name: '내 인강 시간',
                    {# 색상 #}
                    color: 'rgba(0,128,0,.9)',
                    data: [{{ report.study_data.korean_lecture_study }}, {{ report.study_data.math_lecture_study }}, {{ report.study_data.english_lecture_study }}, {{ report.study_data.research_lecture_study }}],
                    pointPadding: 0.4,
                    pointPlacement: -0.2
                }, {
                    name: '총 학생 자습 시간 평균',
                    {# 색상 #}
                    color: 'rgba(135,206,235,1)',
                    data: [{{ report.average_data.average_korean_self_study }}, {{ report.average_data.average_math_self_study }}, {{ report.average_data.average_english_self_study }}, {{ report.average_data.average_research_self_study }}],
                    pointPadding: 0.3,
                    pointPlacement: 0.2,
                }, {
                    name: '내 자습 시간',
                    {# 색상 #}
                    color: 'rgba(0,0,128,.9)',
                    data: [{{ report.study_data.korean_self_study }}, {{ report.study_data.math_self_study }}, {{ report.study_data.english_self_study }}, {{ report.study_data.research_self_study}}],
                    pointPadding: 0.4,
                    pointPlacement: 0.2,
                }]
            });
        {% endfor %}
    </script>

    {#    총 학습 시간에 대한 평균 그래프 #}
    <script>
        {% for report in weekly_reports %}
            Highcharts.chart('container_column_total{{ forloop.counter }}', {
                chart: {
                    type: 'column',
                    height: (10 / 16 * 100) + '%'
                },
                title: {
                    text: '전체 학생 대비 내 공부량'
                },
                xAxis: {
                    categories: [
                        '총 인강 시간',
                        '총 자습 시간',
                        '총 학습 시간'
                    ]
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: ''
                    }
                },
                legend: {
                    shadow: false
                },
                tooltip: {
                    shared: true
                },
                plotOptions: {
                    column: {
                        grouping: false,
                        shadow: false,
                        borderWidth: 0
                    }
                },
                series: [{
                    name: '총 학습 평균',
                    {# 연두색 #}
                    color: 'rgba(255,192,76,1)',
                    data: [{{ report.average_data.average_total_lecture_study }}, {{ report.average_data.average_total_self_study }}, {{ report.average_data.average_total_study }}],
                    pointPadding: 0.3,
                    pointPlacement: -0.2
                }, {
                    name: '내 학습 시간',
                    {# 색상 #}
                    color: 'rgba(255,0,0,.9)',
                    data: [{{ report.study_data.total_lecture_study }}, {{ report.study_data.total_self_study}}, {{ report.study_data.total_study }}],
                    pointPadding: 0.4,
                    pointPlacement: -0.2
                }]
            });
        {% endfor %}
    </script>

    {#    정규분포 #}
{#    <script>#}
{#        {% for report in weekly_reports %}#}
{#            var week_data = [#}
{#                {% for week, data_list in week_data.items %}#}
{#                    {% if week in data.filtered.week_name %}#}
{#                        {#}
{#                            name: '{{ week }}',#}
{#                            type: 'line',#}
{#                            data: {{ data_list }},#}
{#                            accessibility: {#}
{#                                exposeAsGroupOnly: true#}
{#                            },#}
{#                            marker: {#}
{#                                radius: 1.5#}
{#                            }#}
{#                        }#}
{#                    {% endif %}#}
{#                {% endfor %}#}
{#            ];#}
{##}
{#            Highcharts.chart('container_bell_curve_{{ forloop.counter }}', {#}
{#                chart: {#}
{#                    height: (11 / 16 * 100) + '%'#}
{#                },#}
{#                title: {#}
{#                    text: '총 학습 시간 순위'#}
{#                },#}
{#                xAxis: [{#}
{#                    title: {#}
{#                        text: ''#}
{#                    },#}
{#                    alignTicks: false#}
{#                }, {#}
{#                    title: {#}
{#                        text: 'Bell curve'#}
{#                    },#}
{#                    alignTicks: false,#}
{#                    opposite: true#}
{#                }],#}
{#                yAxis: [{#}
{#                    title: {text: 'Data'}#}
{#                }, {#}
{#                    title: {text: 'Bell curve'},#}
{#                    opposite: true#}
{#                }],#}
{#                series: week_data#}
{#            });#}
{#        {% endfor %}#}
{#    </script>#}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="text/javascript">
    $(document).ready(function(){
        $(".save-btn").on("click", function(){
            var targetId = $(this).data('target');
            var studentName = $(this).data('student-name');
            var weekName = $(this).data('week-name');
            html2canvas($('#' + targetId)[0]).then(function(canvas){
                var img = document.createElement("a");
                img.download = studentName + '_' + weekName + '_report.png'; // 파일 이름 설정
                img.href = canvas.toDataURL();
                document.body.appendChild(img);
                img.click();
            });
        });
    });
</script>
{% endblock %}