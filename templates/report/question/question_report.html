{% extends 'base.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            {% include 'manager/manager_main_menu.html' %}
            <div class="col-md-10">
                <div class="container">
                    {% if student %}
                        <form method="GET" action="{% url 'report:question_report' student.id %}">
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <div class="card mb-3">
                                        <div class="card-header bg-success-subtle">
                                            <h1>{{ student.student }}</h1>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-secondary mb-3" style="height: 10rem">
                                        <div class="card-header bg-danger-subtle">영어 단어</div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="id_start_date" class="form-label">시작일</label>
                                                    <input type="date" class="form-control" id="id_start_date" name="start_date"
                                                           value="{{ form.start_date.value|default_if_none:'' }}">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="id_end_date" class="form-label">마지막일</label>
                                                    <input type="date" class="form-control" id="id_end_date" name="end_date"
                                                           value="{{ form.end_date.value|default_if_none:'' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-secondary mb-3" style="height: 10rem">
                                        <div class="card-header bg-info-subtle">질의응답</div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-5">
                                                    <label for="id_start_date" class="form-label">시작일</label>
                                                    <input type="date" class="form-control" id="id_start_date" name="start_date"
                                                           value="{{ form.start_date.value|default_if_none:'' }}">
                                                </div>
                                                <div class="col-md-5">
                                                    <label for="id_end_date" class="form-label">마지막일</label>
                                                    <input type="date" class="form-control" id="id_end_date" name="end_date"
                                                           value="{{ form.end_date.value|default_if_none:'' }}">
                                                </div>
                                                <div class="col-md-2">
                                                    <button class="btn btn-outline-success" type="submit" id="button"
                                                            style="vertical-align: center">검색
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    {% endif %}
                </div>
                    <div class="container-fluid border mb-3" id="report_div_{{ forloop.counter }}" style="width:1160px; height:720px">
                        <div class="row mt-2">
                            <div class="col-md-2 mb-2">
                                <div style="height:515px">
                                    <div class="card">
                                        <div class="card-header bg-success-subtle"
                                             style="display: flex; align-items: center;">
                                            <h2 class="card-title" style="margin: 0;">
                                                <strong>{{ student.student }}</strong></h2>
                                        </div>
                                        <div class="card-header">
                                            <h4 class="card-text">{{ report.week_name }}</h4>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text" style="font-size:17px">{{ report.start_date }} ~ </p>
                                            <p class="card-text" style="font-size:17px">{{ report.end_date }}</p>
                                        </div>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item bg-light"
                                                style="white-space: nowrap;"></li>
                                            <li class="list-group-item bg-danger text-white"
                                                style="white-space: nowrap; font-size:20px">
                                                <div class="row">
                                                    <div class="col-md-6" style="text-align: center">
                                                        <strong>수면</strong>
                                                    </div>
                                                    <div class="col-md-6">{{ report.study_counts.sleep }}회</div>
                                                </div>
                                            </li>
                                            <li class="list-group-item bg-light"
                                                style="white-space: nowrap;"></li>
                                            <li class="list-group-item bg-info-subtle"
                                                style="white-space: nowrap; font-size:20px">
                                                <div class="row">
                                                    <div class="col-md-6" style="text-align: center">
                                                        <strong>집중도</strong>
                                                    </div>
                                                    <div class="col-md-6"
                                                         style="text-align: center">{{ report.focus_score.focus_score }}</div>
                                                </div>
                                            </li>
                                            <li class="list-group-item bg-light"
                                                style="white-space: nowrap;"></li>
                                            <li class="list-group-item"
                                                style="white-space: nowrap; font-size: 15px">
                                                <div class="row">
                                                    <div class="col-md-5" style="text-align: left; font-size:18px">
                                                        <strong>총 인강</strong>
                                                    </div>
                                                    <div class="col-md-7" style="text-align: left; font-size:18px">
                                                        {{ report.study_data.total_lecture_study_hour }}h
                                                        {{ report.study_data.total_lecture_study_min }}m
                                                    </div>
                                                </div>
                                            </li>
                                            <li class="list-group-item"
                                                style="white-space: nowrap; font-size: 15px">
                                                <div class="row">
                                                    <div class="col-md-5" style="text-align: left; font-size:18px">
                                                        <strong>총 자습</strong>
                                                    </div>
                                                    <div class="col-md-7" style="text-align: left; font-size:18px">
                                                        {{ report.study_data.total_self_study_hour }}h
                                                        {{ report.study_data.total_self_study_min }}m
                                                    </div>
                                                </div>
                                            </li>
                                            <li class="list-group-item bg-light"
                                                style="white-space: nowrap;"></li>
                                            <li class="list-group-item"
                                                style="white-space: nowrap; font-size: 15px">
                                                <div class="row">
                                                    <div class="col-md-5" style="text-align: left; font-size:18px">
                                                        <strong>총 학습</strong>
                                                    </div>
                                                    <div class="col-md-7" style="text-align: left; font-size:18px">
                                                        {{ report.study_data.total_study_hour }}h
                                                        {{ report.study_data.total_study_min }}m
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div>
                                    <img style="max-height: 156px; margin-left:-20px" src="{% static '3.jpg' %}"
                                         alt="logo"/>
                                    <img src="{% static 'save_btn.png' %}"
                                         class="save-btn"
                                         data-target="report_div_{{ forloop.counter }}"
                                         data-student-name="{{ report.student_name }}"
                                         data-week-name="{{ report.week_name }}"
                                         alt="이미지 저장" style="cursor:pointer; height:30px; width:30px; opacity:0.05"/>
                                </div>
                            </div>
                            <div class="col-md-10">
                                <div class="card border border-success" style="height:700px">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div id="demo-desktop-month-view"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="demo-desktop-month-view"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{#    이미지 저장 버튼 코드 #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="text/javascript">
    $(document).ready(function(){
        $(".save-btn").on("click", function(){
            var targetId = $(this).data('target');
            var studentName = $(this).data('student-name');
            var weekName = $(this).data('week-name');
            var button = $(this); // 현재 버튼을 변수에 저장
            button.hide(); // 버튼을 숨깁니다

            html2canvas($('#' + targetId)[0]).then(function(canvas){
                var img = document.createElement("a");
                img.download = studentName + '_' + weekName + '_report.png'; // 파일 이름 설정
                img.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                document.body.appendChild(img);
                img.click();
                document.body.removeChild(img); // 생성된 링크를 제거합니다
                button.show(); // 이미지 캡쳐 후 버튼을 다시 보여줍니다
            });
        });
    });
    </script>
    <script>
        var inst = mobiscroll.eventcalendar('#demo-desktop-month-view', {
          theme: 'auto',
          themeVariant: 'light',
          clickToCreate: false,
          dragToCreate: false,
          dragToMove: false,
          dragToResize: false,
          eventDelete: false,
          view: {
            calendar: { labels: true },
          },
          onEventClick: function (event, inst) {
            mobiscroll.toast({
              message: event.event.title,
            });
          },
        });

        mobiscroll.getJson(
          'https://trial.mobiscroll.com/events/?vers=5',
          function (events) {
            inst.setEvents(events);
          },
          'jsonp',
        );
    </script>
{% endblock %}